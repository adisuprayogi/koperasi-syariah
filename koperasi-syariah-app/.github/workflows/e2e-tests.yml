name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - auth
        - anggota
        - pengurus
        - admin
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: false
        type: boolean

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: koperasi_syariah_testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, bcmath, ctype, fileinfo, json, tokenizer, pdo, pdo_mysql, curl, dom, zip, gd, iconv, intl, Sodium
        coverage: none

    - name: Copy environment file
      run: |
        cp .env.example .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=127.0.0.1" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=koperasi_syariah_testing" >> .env
        echo "DB_USERNAME=root" >> .env
        echo "DB_PASSWORD=password" >> .env
        echo "APP_ENV=testing" >> .env
        echo "APP_URL=http://127.0.0.1:8010" >> .env

    - name: Get Composer Cache Directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: tests/e2e/package-lock.json

    - name: Install Playwright dependencies
      run: |
        cd tests/e2e
        npm ci
        npx playwright install chromium

    - name: Generate application key
      run: php artisan key:generate

    - name: Set up database
      run: |
        php artisan migrate:fresh --seed --force
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

    - name: Create storage link
      run: php artisan storage:link

    - name: Create test directories
      run: |
        mkdir -p tests/e2e/reports/html
        mkdir -p tests/e2e/reports/screenshots
        mkdir -p tests/e2e/reports/videos
        mkdir -p tests/e2e/logs

    - name: Start Laravel application
      run: |
        php artisan serve --host=0.0.0.0 --port=8010 > tests/e2e/logs/application.log 2>&1 &
        echo "APP_PID=$!" >> $GITHUB_ENV

    - name: Wait for application to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://127.0.0.1:8010; do sleep 2; done'

    - name: Determine test type
      id: test-type
      run: |
        if [ "${{ github.event.inputs.test_type }}" != "" ]; then
          echo "type=${{ github.event.inputs.test_type }}" >> $GITHUB_OUTPUT
        else
          echo "type=all" >> $GITHUB_OUTPUT
        fi

    - name: Determine debug mode
      id: debug-mode
      run: |
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          echo "debug=--debug" >> $GITHUB_OUTPUT
        else
          echo "debug=" >> $GITHUB_OUTPUT
        fi

    - name: Run E2E Tests
      run: |
        cd tests/e2e
        export APP_URL=http://127.0.0.1:8010

        # Run tests based on input or default
        case "${{ steps.test-type.outputs.type }}" in
          "auth")
            npm run test:auth
            ;;
          "anggota")
            npm run test:anggota
            ;;
          "pengurus")
            npm run test:pengurus
            ;;
          "admin")
            npm run test:admin
            ;;
          "all"|*)
            npm run test
            ;;
        esac

    - name: Stop Laravel application
      if: always()
      run: |
        if [ -n "$APP_PID" ]; then
          kill $APP_PID || true
        fi
        pkill -f "php artisan serve" || true

    - name: Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-reports
        path: |
          tests/e2e/reports/
          tests/e2e/logs/
        retention-days: 30

    - name: Upload screenshots
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: e2e-test-screenshots
        path: tests/e2e/reports/screenshots/
        retention-days: 30

    - name: Upload videos
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: e2e-test-videos
        path: tests/e2e/reports/videos/
        retention-days: 30

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: E2E Test Results
        path: tests/e2e/reports/junit.xml
        reporter: java-junit
        fail-on-error: false

  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist

    - name: Run security audit
      run: |
        composer audit
        find . -name "*.php" -exec php -l {} \;

  code-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install ESLint (if package.json exists)
      if: hashFiles('package.json') != ''
      run: npm install eslint

    - name: Run code quality checks
      run: |
        # Check for syntax errors in JavaScript files
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./vendor/*" -exec node -c {} \; 2>/dev/null || true

        # Check for common PHP code issues
        find . -name "*.php" -not -path "./vendor/*" -not -path "./storage/*" -not -path "./bootstrap/cache/*" -exec php -l {} \;